# НАП ДДС Експорт - Документация

## Общо описание
Модулът за експорт на ДДС файлове генерира файлове в специфичен формат изискван от НАП (Национална агенция за приходите) за подаване на ДДС декларации.

## Генерирани файлове

### 1. DEKLAR.TXT
Съдържа обобщена информация за ДДС декларацията за съответния период.

**Формат:** Фиксирана дължина на полетата, един запис
- ДДС номер: 15 символа
- Име на фирмата: 80 символа  
- Период: 6 символа (YYYYMM)
- Брой записи продажби: 14 символа
- Брой записи покупки: 14 символа
- Числови полета за суми: по 13 символа, 2 десетични знака

### 2. POKUPKI.TXT
Детайлна информация за всички покупки за периода.

**Формат:** Фиксирана дължина на полетата, по един запис на ред
- ДДС номер: 15 символа
- Период: 6 символа (YYYYMM)
- Резервирано поле: 15 символа
- Номер по ред: 15 символа
- Вид документ: 2 символа
- Номер на документ: 13 символа
- Дата на документ: 10 символа (DD/MM/YYYY)
- ДДС номер на контрагент: 15 символа
- Име на контрагент: 50 символа
- Местоположение: 50 символа
- Числови полета (11 броя): по 13 символа, 2 десетични знака

### 3. PRODAGBI.TXT
Детайлна информация за всички продажби за периода.

**Формат:** Идентичен с POKUPKI.TXT

## Технически детайли

### Кодиране
- **Кодова страница:** Windows-1251 (CP-1251)
- **Край на ред:** CRLF (\r\n)

### Имплементация
Файл: `backend/src/services/nap_export.rs`

```rust
pub struct NapExportService;

impl NapExportService {
    pub async fn generate_vies_files(
        db: &DatabaseConnection,
        company_id: i32,
        year: i32,
        month: i32,
    ) -> Result<ViesFiles>
}
```

### GraphQL API
```graphql
mutation {
  generateVatFiles(companyId: 1, year: 2025, month: 7) {
    success
    deklarContent
    pokupkiContent
    prodagbiContent
  }
}
```

## Изисквания на НАП

### Общи изисквания
1. Файловете трябва да са текстови с кодиране Windows-1251
2. Между полетата няма разделители
3. Незаетите позиции се попълват с интервали
4. Числовите полета са подравнени отдясно
5. Текстовите полета са подравнени отляво

### Валидация
- ДДС номерата трябва да започват с "BG"
- Датите трябва да са валидни
- Сумите трябва да съответстват на записите в дневниците

## Тестване

### Локално тестване
1. Генерирайте файловете през GraphQL API
2. Проверете кодирането: `file -bi DEKLAR.TXT`
3. Проверете съдържанието: `iconv -f cp1251 -t utf8 DEKLAR.TXT`

### Тестване на Windows
1. Отворете файловете с Notepad
2. Проверете дали кирилицата се показва коректно
3. Качете през портала на НАП за валидация

## Промени (Септември 2025)

### Версия 1.1.0
- Преминаване от CSV формат към фиксирана дължина на полетата
- Добавено кодиране Windows-1251
- Коригиран формат на датите (YYYYMM за период, DD/MM/YYYY за документи)
- Добавени CRLF line endings
- Подобрено форматиране на числови полета

## Известни проблеми
- При липса на данни за периода, файловете POKUPKI.TXT и PRODAGBI.TXT ще са празни (само с header)

## Контакти
За въпроси и поддръжка: dev@company.bg