# Валидационни правила

## Общи принципи

Валидацията се извършва на няколко нива:
1. **Структурна** - съответствие със JSON схемата
2. **Бизнес логика** - счетоводни и ДДС правила
3. **AI качество** - confidence scores и предупреждения
4. **Интеграция** - съвместимост със счетоводната система

## Нива на валидация

### Ниво 1: Критични грешки (блокиращи)
Импортът не може да продължи

### Ниво 2: Предупреждения (важни)
Импортът може да продължи, но се препоръчва корекция

### Ниво 3: Забележки (информативни)
Информация за преглед

## Валидационни правила по категории

### 1. Структура на документа

#### Критични грешки
- [ ] Липсва `documentType`
- [ ] Липсва `transactionType` (PURCHASE/SALE)
- [ ] Липсва `documentNumber`
- [ ] Липсва `documentDate`
- [ ] Невалиден формат на дата (трябва YYYY-MM-DD)
- [ ] Липсват счетоводни записи

#### Предупреждения
- [ ] Липсва `dueDate` при фактура
- [ ] Липсва `originalInvoice` при кредитно/дебитно известие
- [ ] Документна дата е в бъдещето

### 2. Контрагент информация

#### Критични грешки
- [ ] Липсва име на контрагент
- [ ] Невалиден формат на ЕИК (9-13 цифри)
- [ ] Невалиден формат на ДДС номер (BG + 9-10 цифри)

#### Предупреждения
- [ ] Липсва ЕИК при български контрагент
- [ ] Липсва ДДС номер при `isVatRegistered: true`
- [ ] Несъответствие между ЕИК и ДДС номер
- [ ] Липсва адрес или град

#### Валидация на ЕИК
```javascript
function validateEIK(eik) {
  if (!/^[0-9]{9}$/.test(eik) && !/^[0-9]{13}$/.test(eik)) {
    return false;
  }
  
  // Контролна сума за 9-цифрен ЕИК
  if (eik.length === 9) {
    const weights = [1, 2, 3, 4, 5, 6, 7, 8];
    let sum = 0;
    for (let i = 0; i < 8; i++) {
      sum += parseInt(eik[i]) * weights[i];
    }
    const checkDigit = sum % 11;
    const expectedDigit = checkDigit === 10 ? 0 : checkDigit;
    return parseInt(eik[8]) === expectedDigit;
  }
  
  return true; // За 13-цифрен ЕГН
}
```

### 3. Суми и изчисления

#### Критични грешки
- [ ] `totalAmount` ≠ `netAmount` + `vatAmount`
- [ ] Отрицателни суми при обикновена фактура
- [ ] Положителни суми при кредитно известие
- [ ] Сума на редовете ≠ обща сума

#### Предупреждения
- [ ] ДДС сума ≠ данъчна основа × ставка (толеранс 0.01 лв)
- [ ] Необичайно големи суми (> 100,000 лв)
- [ ] Закръгляне над 0.05 лв

#### Формули за валидация
```
totalAmount = netAmount + vatAmount (±0.01)
vatAmount = netAmount × (vatRate / 100) (±0.01)
Σ(lineItems.totalAmount) = document.totalAmount (±0.01)
```

### 4. Счетоводни записи

#### Критични грешки
- [ ] Дебит ≠ Кредит (документът не е балансиран)
- [ ] Липсва код на сметка
- [ ] Невалиден код на сметка (не е 3-4 цифри)
- [ ] И дебит, и кредит > 0 в един запис

#### Предупреждения
- [ ] Сметката не съществува в сметкоплана
- [ ] Неправилна сметка за типа операция
- [ ] Липсва описание на записа
- [ ] Дублирани записи

#### Правила за балансираност
```
Σ(debit) = Σ(credit)
За всеки запис: (debit > 0 AND credit = 0) OR (debit = 0 AND credit > 0)
```

### 5. ДДС валидация

#### Критични грешки
- [ ] Липсва `vatRegister` (1 или 2)
- [ ] Липсва `vatPeriod` 
- [ ] Невалиден формат на период (YYYY-MM)
- [ ] Липсват ДДС операции при ДДС документ
- [ ] Невалидна ДДС ставка (различна от 0, 9, 20)

#### Предупреждения
- [ ] Несъответствие между `vatRegister` и `transactionType`
- [ ] Невалиден код на операция за типа транзакция
- [ ] ДДС без контрагент с ДДС номер
- [ ] Протокол без двойно осчетоводяване (4531 и 4532)

#### ДДС правила по операции

**Покупки (vatRegister: 1)**
- Код 01-02: Изисква ДДС номер на доставчика
- Код 03: Без право на данъчен кредит
- Код 07-08: ВОП - изисква протокол

**Продажби (vatRegister: 2)**
- Код 01-02: Стандартни облагаеми доставки
- Код 03-04: Нулева ставка (износ/ВОД)
- Код 12: ВОД - изисква ЕС контрагент

### 6. AI разпознаване

#### Критични грешки
- [ ] Общ confidence < 0.70
- [ ] `needsReview: true` с confidence < 0.80

#### Предупреждения
- [ ] Confidence за суми < 0.95
- [ ] Confidence за контрагент < 0.85
- [ ] Confidence за ДДС < 0.90
- [ ] Наличие на warnings в AI полето

#### Прагове за confidence
```
Минимални стойности:
- documentNumber: 0.95
- amounts: 0.98
- counterpart: 0.85
- vatDetails: 0.90
```

### 7. Специфични документи

#### Кредитни/Дебитни известия
- [ ] Изисква `originalInvoice`
- [ ] Сумите трябва да са с обратен знак
- [ ] `isCreditNote: true` за ДДС операции
- [ ] Същия контрагент като оригиналната фактура

#### Протоколи по чл.117
- [ ] `isProtocol: true` в ДДС операции
- [ ] Задължително сметки 4531 и 4532
- [ ] Код 07 или 08 за ВОП
- [ ] Изисква основание в описанието

### 8. Логически проверки

#### Хронология
- [ ] Дата на документа ≤ днешна дата
- [ ] Дата на падеж ≥ дата на документа
- [ ] ДДС период съответства на месеца на документа

#### Дублиране
- [ ] Проверка за дублиран номер на документ
- [ ] Проверка за идентични суми и дата
- [ ] Предупреждение при множество фактури от един контрагент в един ден

## Процес на валидация

### Стъпка 1: Pre-validation
```json
{
  "step": "pre-validation",
  "checks": [
    "JSON structure",
    "Required fields",
    "Data types"
  ]
}
```

### Стъпка 2: Business validation
```json
{
  "step": "business-validation",
  "checks": [
    "Balance check",
    "VAT calculation",
    "Account codes",
    "Counterpart data"
  ]
}
```

### Стъпка 3: AI quality check
```json
{
  "step": "ai-quality",
  "checks": [
    "Confidence scores",
    "Warnings review",
    "Manual review flags"
  ]
}
```

### Стъпка 4: Integration check
```json
{
  "step": "integration",
  "checks": [
    "Account mapping",
    "Counterpart exists",
    "Duplicate check"
  ]
}
```

## Резултат от валидацията

### Успешна валидация
```json
{
  "status": "SUCCESS",
  "errors": [],
  "warnings": [],
  "info": ["Документът е готов за импорт"],
  "canImport": true
}
```

### Валидация с предупреждения
```json
{
  "status": "WARNING",
  "errors": [],
  "warnings": [
    "Сметка 302 не съществува в сметкоплана",
    "Confidence за контрагент е 0.82 (под препоръчителното)"
  ],
  "info": [],
  "canImport": true,
  "requiresConfirmation": true
}
```

### Неуспешна валидация
```json
{
  "status": "ERROR",
  "errors": [
    "Документът не е балансиран: Дебит (1000) ≠ Кредит (1200)",
    "Липсва задължително поле: documentDate"
  ],
  "warnings": [],
  "info": [],
  "canImport": false
}
```

## Автоматични корекции

Системата може автоматично да коригира:

1. **Форматиране**
   - Премахване на интервали в ЕИК/ДДС номер
   - Главни букви в ДДС номер
   - Форматиране на дати

2. **Закръгляне**
   - Закръгляне до 2 знака след десетичната точка
   - Корекция на минимални разлики (< 0.01)

3. **Допълване**
   - Добавяне на "BG" към ДДС номер
   - Изчисляване на липсващи суми
   - Генериране на описания

## Конфигурация на валидацията

```json
{
  "validationConfig": {
    "strictMode": false,
    "allowPartialImport": true,
    "autoCorrect": true,
    "tolerance": {
      "amounts": 0.01,
      "vat": 0.01
    },
    "confidence": {
      "minimum": 0.70,
      "recommended": 0.85
    },
    "limits": {
      "maxAmount": 1000000,
      "warningAmount": 100000
    }
  }
}
```

## Troubleshooting

### Чести проблеми и решения

1. **"Документът не е балансиран"**
   - Проверете всички счетоводни записи
   - Уверете се, че Σ(дебит) = Σ(кредит)

2. **"Невалиден ЕИК"**
   - Проверете за правилен брой цифри (9 или 13)
   - Валидирайте контролната сума

3. **"ДДС изчислението е грешно"**
   - Проверете ДДС ставката
   - Закръглете до 2 знака

4. **"Липсва сметка в сметкоплана"**
   - Използвайте мапинг правила
   - Добавете сметката в системата

5. **"Ниско AI confidence"**
   - Прегледайте ръчно документа
   - Коригирайте разпознатите полета