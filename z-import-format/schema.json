{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "AI Document Recognition Import Format",
  "type": "object",
  "required": ["version", "source", "timestamp", "documents"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "Версия на формата"
    },
    "source": {
      "type": "string",
      "enum": ["AI_DOCUMENT_RECOGNITION", "OCR", "MANUAL"],
      "description": "Източник на данните"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Време на създаване на файла"
    },
    "documents": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/document"
      }
    },
    "vatSummary": {
      "$ref": "#/definitions/vatSummary"
    },
    "mappingRules": {
      "$ref": "#/definitions/mappingRules"
    },
    "validationErrors": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "importSettings": {
      "$ref": "#/definitions/importSettings"
    }
  },
  "definitions": {
    "document": {
      "type": "object",
      "required": ["documentType", "transactionType", "documentNumber", "documentDate", "amounts"],
      "properties": {
        "documentType": {
          "type": "string",
          "enum": ["INVOICE", "CREDIT_NOTE", "DEBIT_NOTE", "PROTOCOL"],
          "description": "Тип на документа"
        },
        "transactionType": {
          "type": "string",
          "enum": ["PURCHASE", "SALE"],
          "description": "Тип на транзакцията"
        },
        "documentNumber": {
          "type": "string",
          "minLength": 1,
          "description": "Номер на документа"
        },
        "documentDate": {
          "type": "string",
          "format": "date",
          "description": "Дата на документа"
        },
        "dueDate": {
          "type": "string",
          "format": "date",
          "description": "Дата на падеж"
        },
        "originalInvoice": {
          "type": "string",
          "description": "Оригинална фактура (за кредитни/дебитни известия)"
        },
        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "default": "BGN",
          "description": "Валута"
        },
        "counterpart": {
          "$ref": "#/definitions/counterpart"
        },
        "amounts": {
          "$ref": "#/definitions/amounts"
        },
        "vatDetails": {
          "$ref": "#/definitions/vatDetails"
        },
        "lineItems": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/lineItem"
          }
        },
        "accountingEntries": {
          "type": "array",
          "minItems": 2,
          "items": {
            "$ref": "#/definitions/accountingEntry"
          }
        },
        "aiRecognition": {
          "$ref": "#/definitions/aiRecognition"
        },
        "purchaseVatCodes": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "saleVatCodes": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "counterpart": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Име на контрагента"
        },
        "eik": {
          "type": "string",
          "pattern": "^[0-9]{9,13}$",
          "description": "ЕИК/БУЛСТАТ"
        },
        "vatNumber": {
          "type": "string",
          "pattern": "^BG[0-9]{9,10}$",
          "description": "ДДС номер"
        },
        "address": {
          "type": "string",
          "description": "Адрес"
        },
        "city": {
          "type": "string",
          "description": "Град"
        },
        "country": {
          "type": "string",
          "pattern": "^[A-Z]{2}$",
          "description": "Държава (ISO код)"
        },
        "isVatRegistered": {
          "type": "boolean",
          "description": "Регистрация по ДДС"
        }
      }
    },
    "amounts": {
      "type": "object",
      "required": ["netAmount", "vatAmount", "totalAmount"],
      "properties": {
        "netAmount": {
          "type": "number",
          "description": "Данъчна основа"
        },
        "vatAmount": {
          "type": "number",
          "description": "ДДС сума"
        },
        "totalAmount": {
          "type": "number",
          "description": "Обща сума с ДДС"
        }
      }
    },
    "vatDetails": {
      "type": "object",
      "required": ["vatRegister", "vatPeriod", "operations"],
      "properties": {
        "vatRegister": {
          "type": "integer",
          "enum": [1, 2],
          "description": "ДДС регистър (1=покупки, 2=продажби)"
        },
        "vatPeriod": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}$",
          "description": "Данъчен период (YYYY-MM)"
        },
        "operations": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/vatOperation"
          }
        }
      }
    },
    "vatOperation": {
      "type": "object",
      "required": ["operationCode", "taxBase", "vatRate", "vatAmount"],
      "properties": {
        "operationCode": {
          "type": "string",
          "pattern": "^\\d{2}$",
          "description": "Код на ДДС операцията"
        },
        "operationName": {
          "type": "string",
          "description": "Наименование на операцията"
        },
        "taxBase": {
          "type": "number",
          "description": "Данъчна основа"
        },
        "vatRate": {
          "type": "number",
          "enum": [0, 9, 20],
          "description": "ДДС ставка"
        },
        "vatAmount": {
          "type": "number",
          "description": "ДДС сума"
        },
        "deductibleVat": {
          "type": "number",
          "description": "ДДС за приспадане"
        },
        "nonDeductibleVat": {
          "type": "number",
          "description": "ДДС без право на приспадане"
        },
        "isCreditNote": {
          "type": "boolean",
          "description": "Кредитно известие"
        },
        "isProtocol": {
          "type": "boolean",
          "description": "Протокол по чл.117"
        }
      }
    },
    "lineItem": {
      "type": "object",
      "required": ["description", "netAmount"],
      "properties": {
        "description": {
          "type": "string",
          "description": "Описание"
        },
        "quantity": {
          "type": "number",
          "description": "Количество"
        },
        "unitPrice": {
          "type": "number",
          "description": "Единична цена"
        },
        "netAmount": {
          "type": "number",
          "description": "Нетна сума"
        },
        "vatRate": {
          "type": "number",
          "description": "ДДС ставка"
        },
        "vatAmount": {
          "type": "number",
          "description": "ДДС сума"
        },
        "totalAmount": {
          "type": "number",
          "description": "Обща сума"
        },
        "accountCode": {
          "type": "string",
          "description": "Счетоводна сметка"
        }
      }
    },
    "accountingEntry": {
      "type": "object",
      "required": ["accountCode", "debit", "credit"],
      "properties": {
        "accountCode": {
          "type": "string",
          "pattern": "^\\d{3,4}$",
          "description": "Код на сметката"
        },
        "accountName": {
          "type": "string",
          "description": "Име на сметката"
        },
        "debit": {
          "type": "number",
          "minimum": 0,
          "description": "Дебит"
        },
        "credit": {
          "type": "number",
          "minimum": 0,
          "description": "Кредит"
        },
        "description": {
          "type": "string",
          "description": "Описание"
        },
        "counterpartEik": {
          "type": "string",
          "description": "ЕИК на контрагента"
        }
      }
    },
    "aiRecognition": {
      "type": "object",
      "properties": {
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Обща увереност"
        },
        "ocrText": {
          "type": "string",
          "description": "OCR текст"
        },
        "recognizedFields": {
          "type": "object",
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        },
        "suggestedVatCode": {
          "type": "string",
          "description": "Предложен ДДС код"
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "needsReview": {
          "type": "boolean",
          "description": "Нужда от преглед"
        }
      }
    },
    "vatSummary": {
      "type": "object",
      "properties": {
        "period": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}$"
        },
        "purchases": {
          "type": "object",
          "properties": {
            "totalTaxBase": {"type": "number"},
            "totalVat": {"type": "number"},
            "deductibleVat": {"type": "number"},
            "nonDeductibleVat": {"type": "number"},
            "byOperation": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "base": {"type": "number"},
                  "vat": {"type": "number"}
                }
              }
            }
          }
        },
        "sales": {
          "type": "object",
          "properties": {
            "totalTaxBase": {"type": "number"},
            "totalVat": {"type": "number"},
            "byOperation": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "base": {"type": "number"},
                  "vat": {"type": "number"}
                }
              }
            }
          }
        },
        "vatPayable": {
          "type": "number",
          "description": "ДДС за внасяне"
        }
      }
    },
    "mappingRules": {
      "type": "object",
      "properties": {
        "accounts": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "vatCodes": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "importSettings": {
      "type": "object",
      "properties": {
        "validateBeforeImport": {
          "type": "boolean",
          "default": true
        },
        "autoCreateCounterparts": {
          "type": "boolean",
          "default": true
        },
        "groupByDocument": {
          "type": "boolean",
          "default": true
        },
        "skipDuplicates": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "validationRules": {
      "type": "object",
      "properties": {
        "checkVatNumber": {
          "type": "boolean",
          "default": true
        },
        "validateVatCalculation": {
          "type": "boolean",
          "default": true
        },
        "requireCounterpartVat": {
          "type": "boolean",
          "default": true
        },
        "allowPartialDeduction": {
          "type": "boolean",
          "default": false
        },
        "protocolRequires82": {
          "type": "boolean",
          "default": true
        }
      }
    }
  }
}