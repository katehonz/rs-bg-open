# Controlisy Import - Документация

## Общо описание
Системата поддържа импортиране на XML файлове от Controlisy, съдържащи счетоводни документи (фактури за покупка и продажба). Импортът автоматично създава журнални записи и контрагенти в системата.

## Разпознаване на тип документ (Покупка/Продажба)

### Йерархия на разпознаване
Системата използва няколко метода за определяне дали документът е покупка или продажба, в следния приоритет:

#### 1. VAT Register (най-надежден метод)
Проверява се атрибутът `vatRegister` в елемента `VATData`:
- **`vatRegister="1"`** - Документът е **ПОКУПКА**
- **`vatRegister="2"`** - Документът е **ПРОДАЖБА**

```xml
<VATData vatRegister="1" contractorName="..." contractorVATNumber="...">
  <!-- VAT данни -->
</VATData>
```

#### 2. Анализ на счетоводните сметки
Ако няма `vatRegister`, системата анализира използваните счетоводни сметки:

**Индикатори за ПОКУПКА:**
- Сметки 401, 402, 404, 408 (доставчици) - кредитирани
- Сметки 2xx (материали), 3xx (стоки), 6xx (разходи) - дебитирани
- Сметка 4531 (ДДС за възстановяване) - дебитирана

**Индикатори за ПРОДАЖБА:**
- Сметки 411, 412 (клиенти) - дебитирани
- Сметки 7xx (приходи) - кредитирани
- Сметка 4532 (ДДС за внасяне) - кредитирана

#### 3. Име на файла (резервен метод)
Ако горните методи не дадат резултат, се проверява името на файла:
- Съдържа "pokupki" или "покупки" → ПОКУПКА
- Съдържа "prodaj", "prodajbi", "продаж", "продажби" → ПРОДАЖБА

## Структура на XML файла

### Основни елементи

```xml
<?xml version="1.0" encoding="utf-8"?>
<ExportedData>
  <Contractors>
    <!-- Списък с контрагенти -->
  </Contractors>
  <Documents>
    <!-- Списък с документи -->
  </Documents>
</ExportedData>
```

### Контрагенти
```xml
<Contractor 
  contractorName="Име на фирма"
  contractorEIK="123456789"
  contractorVATNumber="BG123456789"
  contractorInsideNumber="001"
  ca_contractorId="1234"
/>
```

### Документи
```xml
<Document
  accountingMonth="2025-07-01"    <!-- Счетоводен месец -->
  vatMonth="2025-07-01"           <!-- ДДС месец -->
  documentDate="2025-07-15"       <!-- Дата на документа -->
  documentNumber="0000001908"     <!-- Номер на документа -->
  reason="Продажба на продукция"  <!-- Основание -->
  netAmountBGN="520.00"          <!-- Сума без ДДС -->
  vatAmountBGN="104.00"          <!-- ДДС -->
  totalAmountBGN="624.00"        <!-- Обща сума с ДДС -->
>
  <Accountings>
    <!-- Счетоводни записи -->
  </Accountings>
  
  <VATData vatRegister="2">      <!-- 1=Покупка, 2=Продажба -->
    <VAT 
      taxBase="520.00"
      vatRate="20"
      vatAmountBGN="104.00"
    />
  </VATData>
</Document>
```

### Счетоводни записи
```xml
<Accounting amountBGN="624.00">
  <AccountingDetail
    direction="Debit"            <!-- Debit или Credit -->
    accountNumber="411"          <!-- Номер на сметка -->
    accountName="Клиенти"        <!-- Име на сметка -->
    contractorName="Име ООД"
  />
  <AccountingDetail
    direction="Credit"
    accountNumber="702"
    accountName="Приходи от продажба на продукция"
  />
</Accounting>
```

## ДДС операции

### За покупки (VAT Purchase Operation)
- **Код "1"** - Получени доставки с право на пълен данъчен кредит (с ДДС)
- **Код "3"** - Получени доставки без ДДС

### За продажби (VAT Sales Operation)
- **Код "1"** - Облагаеми доставки с 20% ДДС
- **Код "8"** - Освободени доставки (без ДДС)

## Обработка на импорта

### Етапи на импорт:
1. **Парсване на XML** - валидация и извличане на данните
2. **Определяне на тип** - за всеки документ поотделно
3. **Създаване на контрагенти** - ако не съществуват
4. **Създаване на журнални записи** - с правилния тип (покупка/продажба)

### Важни особености:
- Всеки документ се обработва индивидуално
- Типът (покупка/продажба) се определя за всеки документ поотделно
- Един файл може да съдържа документи от различен тип
- Системата генерира уникални номера на записи с формат: `CTRL-{doc_number}-{timestamp}-{random}`

## Групово управление на записи

### Групово изтриване
Системата позволява селектиране и изтриване на множество журнални записи наведнъж:
1. Селектирайте записите с чекбоксовете
2. Натиснете "Изтрий избраните"
3. Потвърдете действието

**Ограничения:**
- Не могат да се изтриват приключени записи
- Първо трябва да се отприключат (unpost)

### Групово приключване
Подобно на изтриването, могат да се приключват множество записи наведнъж.

## Решаване на проблеми

### Грешно разпознат тип документ
**Проблем:** Документ е разпознат като покупка вместо продажба или обратно.

**Решение:**
1. Проверете `vatRegister` в XML файла
2. Проверете използваните счетоводни сметки
3. При нужда, коригирайте XML файла преди импорт

### Дублирани записи
**Проблем:** При повторен импорт се създават дублирани записи.

**Решение:**
1. Използвайте груповото изтриване за да премахнете старите записи
2. Импортирайте отново

### Липсващи контрагенти
**Проблем:** Контрагентите не се създават при импорт.

**Решение:**
- Проверете дали ЕИК е валиден в XML файла
- Системата създава контрагенти автоматично на база ЕИК

## Технически детайли

### Файлова структура
- Backend логика: `/backend/src/services/controlisy.rs`
- REST API: `/backend/src/rest/controlisy_api.rs`
- Frontend: `/frontend/src/pages/JournalEntriesList.jsx`

### База данни
- Таблица `controlisy_imports` - съхранява импортите
- Таблица `journal_entries` - създадените журнални записи
- Таблица `counterparts` - контрагенти

### API Endpoints
- `POST /api/controlisy/import` - импорт на XML файл
- `GET /api/controlisy/imports/{company_id}` - списък с импорти
- `POST /api/controlisy/process/{import_id}` - обработка на импорт

## Примерен XML файл

```xml
<?xml version="1.0" encoding="utf-8"?>
<ExportedData>
  <Contractors>
    <Contractor 
      contractorName="Примерна фирма ООД"
      contractorEIK="123456789"
      contractorVATNumber="BG123456789"
      ca_contractorId="1"
    />
  </Contractors>
  <Documents>
    <!-- Фактура за продажба -->
    <Document
      accountingMonth="2025-07-01"
      vatMonth="2025-07-01"
      documentDate="2025-07-30"
      documentNumber="0000001908"
      reason="Продажба на продукция"
      netAmountBGN="520.00"
      vatAmountBGN="104.00"
      totalAmountBGN="624.00"
    >
      <Accountings>
        <Accounting amountBGN="624.00">
          <AccountingDetail
            direction="Debit"
            accountNumber="411"
            accountName="Клиенти"
          />
          <AccountingDetail
            direction="Credit"
            accountNumber="702"
            accountName="Приходи от продукция"
          />
        </Accounting>
      </Accountings>
      <VATData vatRegister="2" contractorName="Примерна фирма ООД">
        <VAT taxBase="520.00" vatRate="20" vatAmountBGN="104.00"/>
      </VATData>
    </Document>
  </Documents>
</ExportedData>
```