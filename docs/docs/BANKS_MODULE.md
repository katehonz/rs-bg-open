# Модул „Банки“ в RS-AC-BG

## Цел и обхват
Модулът „Банки“ автоматизира импорта на банкови извлечения и автоматичното осчетоводяване на транзакциите в RS-AC-BG. Той покрива целия процес – от дефиниране на банкови профили и формати, през качването и парсирането на файлове, до създаването на журнални записи с буферни контировки. Архитектурата е проектирана да поддържа 30–40 различни банки и формати без промени в основния код.

## Основни възможности
- Управление на множество банкови профили за всяка компания.
- Поддръжка на типове формати (MT-940, CAMT.053, XML) и лесно разширяване с нови банки.
- Автоматично създаване на двустранни счетоводни записвания между банковата и буферната сметка.
- История на всеки импорт – брой операции, суми по дебит/кредит, създадени журнали.
- Централизиран REST endpoint за качване на файлове и GraphQL интерфейс за управление.

## База данни
Миграцията `m20241015_000001_create_bank_modules.rs` създава две ключови таблици:

### `bank_profiles`
| Колона | Тип | Описание |
| --- | --- | --- |
| `id` | int | Първичен ключ |
| `company_id` | int | Идентификатор на компанията |
| `name` | string | Име на банката/профила |
| `iban` | string? | Банков IBAN (по избор) |
| `account_id` | int | Основна аналитична сметка (503...) |
| `buffer_account_id` | int | Буферна сметка (499..., 453... и т.н.) |
| `currency_code` | string(3) | Валута на сметката |
| `import_format` | string | Ключ на формата (напр. `UNICREDIT_MT940`) |
| `is_active` | bool | Флаг за активност |
| `settings` | json? | Допълнителни настройки (например мапинг на колони) |
| `created_by`, `created_at`, `updated_at` | мета

### `bank_imports`
| Колона | Тип | Описание |
| --- | --- | --- |
| `id` | int | Първичен ключ |
| `bank_profile_id` | int | Референция към профила |
| `company_id` | int | Референция към компания |
| `file_name` | string | Име на импортирания файл |
| `import_format` | string | Формат, използван при парсване |
| `transactions_count` | int | Брой операции във файла |
| `total_debit` / `total_credit` | decimal | Обобщени суми |
| `created_journal_entries` | int | Създадени журнала |
| `journal_entry_ids` | json? | Списък с ID на журналите |
| `status` | string | `completed`, `failed`, `in_progress` |
| `error_message` | text? | Описание на грешка |
| `created_by`, `created_at`, `updated_at` | мета

## Backend компоненти
- **SeaORM модели**: `backend/src/entities/bank_profile.rs`, `backend/src/entities/bank_import.rs`.
- **Услуга**: `BankImportService` (`backend/src/services/bank_imports.rs`) – декодира файловете, парсира транзакции и създава журнални записи.
- **REST API**: `POST /api/banks/import` (`backend/src/rest/bank_import_api.rs`) приема base64 файл и връща обобщение.
- **GraphQL**: `bank_resolvers.rs` предоставя заявките `bankProfiles`, `bankImports` и мутациите `createBankProfile`, `updateBankProfile`, `setBankProfileStatus`.

## Процес на импорт
1. Потребителят избира предварително дефиниран банков профил.
2. Файлът се валидира локално по разширение/размер и се изпраща към REST endpoint-а.
3. `BankImportService` превръща съдържанието в `BankTransaction` обекти (MT-940 или CAMT.053).
4. За всяка транзакция се създава журнал със следните линии:
   - Дебит 503... (или кредит при дебитна транзакция)
   - Огледална контировка към буферната сметка.
5. В таблица `bank_imports` се записва резултатът, а фронтендът показва историята.

## Поддържани формати
| Формат | Описание | Примерни банки |
| --- | --- | --- |
| `UNICREDIT_MT940` | SWIFT MT-940 текстови файлове | UniCredit Bulbank |
| `WISE_CAMT053` | ISO20022 CAMT.053 XML | Wise | 
| `REVOLUT_CAMT053` | CAMT.053 XML | Revolut | 
| `PAYSERA_CAMT053` | CAMT.053 XML | Paysera | 
| `POSTBANK_XML` | Специфичен XML формат | Пощенска банка |

Добавянето на нов формат става чрез:
1. Добавяне на нов елемент в `BankImportFormat` (enum).
2. Обогатяване на `IMPORT_FORMAT_META` във фронтенда.
3. Имплементация на парсер в `BankImportService::parse_transactions`.

## Frontend
- Страница **„Банки“** (`frontend/src/pages/Banks.jsx`) – CRUD за профилите.
- Компонент **BankImport** (`frontend/src/components/imports/BankImport.jsx`) – избор на профил, качване, прогрес и история.
- Меню „Банки“ е достъпно от страничната лента.

## Сетъп и параметри
1. Изпълнете миграциите: `cargo run -p migration` или през CI.
2. Задайте начални профили (може да се направи през UI).
3. Уверете се, че API-то слуша на `http://127.0.0.1:8080` (споделено с фронтенда).
4. За продукция ограничете достъпа до REST endpoint-а (автентикация, размери на файл).

## План за разширение
- **Нови банки**: структуриран подход за добавяне на още формати и специфични настройки в полето `settings`.
- **Автоматично разпознаване на контрагенти**: на по-късен етап може да се използва IBAN/описание за директно съвпадение с контрагенти.
- **AI предложения**: буферните записи могат да се допълват с автоматично мапиране към реални контировки след човешки преглед.

## Тестване
- `cargo check` и `cargo test` за backend.
- Ръчен импорт на файловете от директория `banki/` (UniCredit, Wise, Revolut, Paysera, Postbank).

## Поддръжка и логване
- Детайлни лога се пазят в `bank_imports` (JSON списък с журнални ID) и в стандартния лог на услугата.
- При грешки REST endpoint-ът връща описателно съобщение, а статусът се маркира като `failed`.

